<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Proton# Studio</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg:        #1a1a1a;
  --bg-dark:   #111111;
  --bg-panel:  #222222;
  --bg-card:   #2a2a2a;
  --border:    #333333;
  --orange:    #FF6B00;
  --orange-lo: rgba(255,107,0,0.12);
  --text:      #f0f0f0;
  --text-dim:  #888888;
  --text-mute: #444444;
  --green:     #6dc86d;
  --red:       #ff6b6b;
  --blue:      #4da6ff;
  --yellow:    #ffc800;
  --purple:    #dda0dd;
}
body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; user-select:none; }

/* â”€â”€ TITLEBAR â”€â”€ */
#titlebar { height:36px; background:var(--bg-dark); display:flex; align-items:center; padding:0 16px; gap:12px; border-bottom:1px solid var(--border); -webkit-app-region:drag; flex-shrink:0; }
#titlebar .logo { font-weight:800; font-size:13px; color:var(--orange); -webkit-app-region:no-drag; }
#titlebar .project-name { font-size:12px; color:var(--text-dim); }
#titlebar .unsaved { width:7px; height:7px; background:var(--orange); border-radius:50%; display:none; }
#titlebar .unsaved.on { display:inline-block; }

/* â”€â”€ MENUBAR â”€â”€ */
#menubar { height:30px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 8px; gap:2px; flex-shrink:0; -webkit-app-region:no-drag; }
.menu-btn { background:none; border:none; color:var(--text-dim); padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px; }
.menu-btn:hover { background:var(--bg-card); color:var(--text); }

/* â”€â”€ TOOLBAR â”€â”€ */
#toolbar { height:38px; background:var(--bg-dark); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; gap:4px; flex-shrink:0; }
.tb { background:none; border:none; color:var(--text-dim); padding:5px 10px; border-radius:6px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:5px; transition:all 0.15s; white-space:nowrap; }
.tb:hover { background:var(--bg-card); color:var(--text); }
.tb.accent { background:var(--orange-lo); color:var(--orange); border:1px solid rgba(255,107,0,0.3); }
.tb.accent:hover { background:var(--orange); color:#fff; }
.tb.play { background:#1a3a1a; color:var(--green); border:1px solid rgba(109,200,109,0.3); }
.tb.play:hover { background:var(--green); color:#fff; }
.tb.stop { background:#3a1a1a; color:var(--red); border:1px solid rgba(255,107,107,0.3); }
.tb.stop:hover { background:var(--red); color:#fff; }
.tb-sep { width:1px; height:20px; background:var(--border); margin:0 2px; }
.tb-right { margin-left:auto; }
.snap-indicator { font-size:11px; color:var(--text-mute); padding:0 8px; }
#snap-status { color:var(--orange); font-weight:600; }

/* â”€â”€ MAIN LAYOUT â”€â”€ */
#main { display:flex; flex:1; overflow:hidden; }

/* â”€â”€ EXPLORER â”€â”€ */
#explorer { width:220px; background:var(--bg-panel); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
.panel-header { height:32px; background:var(--bg-dark); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-mute); gap:8px; }
.panel-header .ph-actions { margin-left:auto; display:flex; gap:2px; }
.ph-btn { background:none; border:none; color:var(--text-mute); cursor:pointer; padding:2px 5px; border-radius:3px; font-size:12px; }
.ph-btn:hover { color:var(--text); background:var(--bg-card); }
#file-tree { flex:1; overflow-y:auto; padding:4px 0; }
#file-tree::-webkit-scrollbar { width:3px; }
#file-tree::-webkit-scrollbar-thumb { background:var(--border); }
.tree-item { display:flex; align-items:center; gap:6px; padding:4px 12px; cursor:pointer; font-size:12px; color:var(--text-dim); transition:background 0.1s; }
.tree-item:hover { background:var(--bg-card); color:var(--text); }
.tree-item.active { background:var(--orange-lo); color:var(--orange); }
.tree-item.folder { color:var(--text); font-weight:600; }
.tree-children { padding-left:12px; }
.tree-icon { font-size:11px; flex-shrink:0; }
#no-project { padding:20px 12px; font-size:12px; color:var(--text-mute); text-align:center; line-height:1.8; }
#no-project button { margin-top:10px; background:var(--orange-lo); border:1px solid var(--orange); color:var(--orange); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:11px; width:100%; }
#no-project button:hover { background:var(--orange); color:#fff; }

/* â”€â”€ CENTER â”€â”€ */
#center { flex:1; display:flex; flex-direction:column; overflow:hidden; }

/* VIEWPORT */
#viewport-area { flex:1; display:flex; flex-direction:column; overflow:hidden; min-height:300px; border-bottom:3px solid var(--border); position:relative; }
#viewport-toolbar { height:32px; background:var(--bg-dark); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 10px; gap:6px; flex-shrink:0; }
.vp-tool { background:none; border:none; color:var(--text-dim); padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px; }
.vp-tool:hover,.vp-tool.active { background:var(--bg-card); color:var(--orange); }
#viewport-canvas-wrap { flex:1; overflow:hidden; position:relative; background:repeating-linear-gradient(0deg, transparent, transparent 24px, var(--border) 24px, var(--border) 25px), repeating-linear-gradient(90deg, transparent, transparent 24px, var(--border) 24px, var(--border) 25px); }
#viewport-canvas { position:absolute; top:0; left:0; }
#viewport-overlay { position:absolute; top:8px; right:8px; display:flex; gap:6px; }
.vp-badge { background:rgba(0,0,0,0.6); border:1px solid var(--border); border-radius:4px; padding:3px 8px; font-size:11px; color:var(--text-dim); }

/* SCRIPT EDITOR */
#script-area { height:260px; display:flex; flex-direction:column; flex-shrink:0; }
#script-tabs { height:32px; background:var(--bg-dark); border-bottom:1px solid var(--border); display:flex; align-items:flex-end; overflow-x:auto; }
#script-tabs::-webkit-scrollbar { height:0; }
.stab { display:flex; align-items:center; gap:5px; padding:0 12px; height:30px; background:var(--bg-panel); border-right:1px solid var(--border); cursor:pointer; font-size:11px; color:var(--text-dim); white-space:nowrap; flex-shrink:0; }
.stab:hover { background:var(--bg-card); color:var(--text); }
.stab.active { background:var(--bg); color:var(--text); border-top:2px solid var(--orange); }
.stab .sdot { width:5px; height:5px; background:var(--orange); border-radius:50%; display:none; }
.stab.unsaved .sdot { display:inline-block; }
.stab-close { background:none; border:none; color:var(--text-mute); cursor:pointer; font-size:13px; padding:0 2px; border-radius:2px; line-height:1; }
.stab-close:hover { color:var(--red); background:var(--bg-card); }
#script-editor-wrap { flex:1; display:flex; overflow:hidden; }
#line-nums { width:46px; background:var(--bg-dark); padding:8px 6px 8px 0; text-align:right; font-family:'JetBrains Mono','Consolas',monospace; font-size:12px; line-height:1.55; color:var(--text-mute); overflow:hidden; flex-shrink:0; border-right:1px solid var(--border); }
#code-editor { flex:1; background:var(--bg); color:var(--text); border:none; outline:none; resize:none; font-family:'JetBrains Mono','Consolas',monospace; font-size:12px; line-height:1.55; padding:8px 12px; caret-color:var(--orange); tab-size:4; white-space:pre; overflow-wrap:normal; overflow:auto; }
#code-editor::-webkit-scrollbar { width:6px; height:6px; }
#code-editor::-webkit-scrollbar-track { background:var(--bg-dark); }
#code-editor::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* â”€â”€ PROPERTIES â”€â”€ */
#properties { width:240px; background:var(--bg-panel); border-left:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; overflow:hidden; }
#prop-content { flex:1; overflow-y:auto; padding:8px; }
#prop-content::-webkit-scrollbar { width:3px; }
#prop-content::-webkit-scrollbar-thumb { background:var(--border); }
.prop-section { margin-bottom:14px; }
.prop-section-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-mute); padding:4px 0 6px; border-bottom:1px solid var(--border); margin-bottom:6px; }
.prop-row { display:flex; align-items:center; margin-bottom:5px; gap:6px; }
.prop-label { font-size:11px; color:var(--text-dim); width:60px; flex-shrink:0; }
.prop-input { flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:4px; color:var(--text); font-size:11px; padding:3px 7px; outline:none; font-family:inherit; }
.prop-input:focus { border-color:var(--orange); }
.prop-color { width:28px; height:22px; border:1px solid var(--border); border-radius:4px; cursor:pointer; padding:0; background:none; }
.prop-empty { color:var(--text-mute); font-size:12px; text-align:center; padding:20px 0; }
.obj-type-badge { display:inline-block; background:var(--orange-lo); color:var(--orange); font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; margin-bottom:10px; border:1px solid rgba(255,107,0,0.3); }

/* â”€â”€ STATUS BAR â”€â”€ */
#statusbar { height:22px; background:var(--orange); display:flex; align-items:center; padding:0 12px; font-size:11px; color:#fff; gap:12px; flex-shrink:0; }
#statusbar .sep { opacity:0.4; }
#statusbar .right { margin-left:auto; display:flex; gap:12px; opacity:0.85; }

/* â”€â”€ OBJECT ITEMS ON CANVAS â”€â”€ */
.canvas-obj { position:absolute; cursor:move; box-sizing:border-box; }
.canvas-obj.selected { outline:2px solid var(--orange) !important; outline-offset:1px; }
.canvas-obj .obj-label { position:absolute; top:-18px; left:0; font-size:10px; color:var(--orange); white-space:nowrap; pointer-events:none; background:rgba(0,0,0,0.6); padding:1px 4px; border-radius:3px; }
.resize-handle { position:absolute; width:8px; height:8px; background:var(--orange); border:1px solid #fff; border-radius:2px; display:none; }
.canvas-obj.selected .resize-handle { display:block; }
.rh-br { bottom:-4px; right:-4px; cursor:se-resize; }
.rh-tr { top:-4px; right:-4px; cursor:ne-resize; }
.rh-bl { bottom:-4px; left:-4px; cursor:sw-resize; }
.rh-tl { top:-4px; left:-4px; cursor:nw-resize; }

/* â”€â”€ CONTEXT MENU â”€â”€ */
#ctx-menu { position:fixed; background:var(--bg-panel); border:1px solid var(--border); border-radius:8px; padding:4px; min-width:160px; z-index:9999; display:none; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
.ctx-item { padding:6px 12px; font-size:12px; color:var(--text-dim); cursor:pointer; border-radius:4px; }
.ctx-item:hover { background:var(--bg-card); color:var(--text); }
.ctx-item.danger { color:var(--red); }
.ctx-sep { height:1px; background:var(--border); margin:3px 0; }

/* â”€â”€ MODAL â”€â”€ */
#modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:10000; }
#modal-overlay.open { display:flex; }
#modal { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:24px; min-width:320px; }
#modal h3 { font-size:15px; margin-bottom:16px; color:var(--text); }
#modal .modal-btns { display:flex; gap:8px; margin-top:20px; justify-content:flex-end; }
#modal .modal-btns button { padding:7px 18px; border-radius:6px; cursor:pointer; font-size:12px; border:none; }
.mb-cancel { background:var(--bg-card); color:var(--text-dim); }
.mb-ok { background:var(--orange); color:#fff; font-weight:600; }
.add-obj-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.add-obj-btn { background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:12px; cursor:pointer; text-align:center; transition:all 0.15s; }
.add-obj-btn:hover { border-color:var(--orange); background:var(--orange-lo); }
.add-obj-btn .icon { font-size:1.5rem; margin-bottom:4px; }
.add-obj-btn .label { font-size:11px; color:var(--text-dim); }
</style>
</head>
<body>

<!-- TITLEBAR -->
<div id="titlebar">
  <span class="logo">âš¡ Proton# Studio</span>
  <span class="project-name" id="project-name">No project open</span>
  <span class="unsaved" id="unsaved-dot"></span>
</div>

<!-- MENUBAR -->
<div id="menubar">
  <button class="menu-btn" onclick="newProject()">File</button>
  <button class="menu-btn" onclick="">Edit</button>
  <button class="menu-btn" onclick="">View</button>
  <button class="menu-btn" onclick="">Object</button>
  <button class="menu-btn" onclick="openDocs()">Help</button>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <button class="tb accent" onclick="newProject()">ğŸ“ New Project</button>
  <button class="tb" onclick="openProject()">ğŸ“‚ Open</button>
  <div class="tb-sep"></div>
  <button class="tb" onclick="saveCurrentScript()">ğŸ’¾ Save</button>
  <button class="tb" onclick="saveScene()">ğŸ’¾ Save Scene</button>
  <div class="tb-sep"></div>
  <button class="tb" onclick="showAddObject()">ï¼‹ Add Object</button>
  <div class="tb-sep"></div>
  <button class="tb play" id="play-btn" onclick="playGame()">â–¶ Play</button>
  <button class="tb stop" id="stop-btn" onclick="stopGame()" style="display:none">â–  Stop</button>
  <div class="tb-sep"></div>
  <span class="snap-indicator">Snap: <span id="snap-status">OFF</span> (Hold Shift)</span>
  <div class="tb-sep"></div>
  <button class="tb tb-right" onclick="openDocs()">ğŸ“– Docs</button>
</div>

<!-- MAIN -->
<div id="main">

  <!-- EXPLORER -->
  <div id="explorer">
    <div class="panel-header">
      Explorer
      <div class="ph-actions">
        <button class="ph-btn" onclick="newScript()" title="New Script">+</button>
        <button class="ph-btn" onclick="openProject()" title="Open Project">ğŸ“</button>
      </div>
    </div>
    <div id="file-tree">
      <div id="no-project">
        <div>No project open</div>
        <button onclick="newProject()">ğŸ“ New Project</button>
        <button onclick="openProject()" style="margin-top:6px;">ğŸ“‚ Open Project</button>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div id="center">

    <!-- VIEWPORT -->
    <div id="viewport-area">
      <div id="viewport-toolbar">
        <button class="vp-tool active" id="tool-select" onclick="setTool('select')" title="Select (V)">â–£ Select</button>
        <button class="vp-tool" id="tool-move" onclick="setTool('move')" title="Move (G)">âœ¥ Move</button>
        <button class="vp-tool" id="tool-pan" onclick="setTool('pan')" title="Pan (H)">âœ‹ Pan</button>
        <div class="tb-sep"></div>
        <button class="vp-tool" onclick="zoomIn()">ï¼‹</button>
        <button class="vp-tool" onclick="zoomOut()">ï¼</button>
        <button class="vp-tool" onclick="resetZoom()">âŠ¡ Reset</button>
        <span style="font-size:11px; color:var(--text-mute); margin-left:6px;" id="zoom-label">100%</span>
        <div id="viewport-overlay">
          <span class="vp-badge" id="obj-count">0 objects</span>
          <span class="vp-badge" id="play-status">â¹ Stopped</span>
        </div>
      </div>
      <div id="viewport-canvas-wrap" oncontextmenu="showCtxMenu(event)"
           onmousedown="vpMouseDown(event)" onmousemove="vpMouseMove(event)"
           onmouseup="vpMouseUp(event)" ondblclick="vpDblClick(event)">
        <canvas id="viewport-canvas"></canvas>
      </div>
    </div>

    <!-- SCRIPT EDITOR -->
    <div id="script-area">
      <div id="script-tabs" id="stabs"></div>
      <div id="script-editor-wrap">
        <div id="line-nums">1</div>
        <textarea id="code-editor" spellcheck="false" placeholder="-- Open a .pros file to start editing"
          oninput="onCodeInput()" onkeydown="onCodeKey(event)" onscroll="syncLineNums()"></textarea>
      </div>
    </div>

  </div>

  <!-- PROPERTIES -->
  <div id="properties">
    <div class="panel-header">Properties</div>
    <div id="prop-content">
      <div class="prop-empty">Select an object<br>to edit its properties</div>
    </div>
  </div>

</div>

<!-- STATUS BAR -->
<div id="statusbar">
  <span id="status-mode">Select</span>
  <span class="sep">|</span>
  <span id="status-file">No file</span>
  <div class="right">
    <span id="status-pos">Ln 1, Col 1</span>
    <span class="sep">|</span>
    <span>Proton# Studio v0.1.0</span>
  </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <div class="ctx-item" onclick="showAddObject()">ï¼‹ Add Object</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxDuplicate()">â§‰ Duplicate</div>
  <div class="ctx-item" onclick="ctxBringForward()">â†‘ Bring Forward</div>
  <div class="ctx-item" onclick="ctxSendBack()">â†“ Send Backward</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" onclick="deleteSelected()">ğŸ—‘ Delete</div>
</div>

<!-- ADD OBJECT MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal">
    <h3>ï¼‹ Add Object</h3>
    <div class="add-obj-grid" id="add-obj-grid">
      <div class="add-obj-btn" onclick="addObject('Sprite')"><div class="icon">ğŸŸ§</div><div class="label">Sprite</div></div>
      <div class="add-obj-btn" onclick="addObject('Rectangle')"><div class="icon">â¬œ</div><div class="label">Rectangle</div></div>
      <div class="add-obj-btn" onclick="addObject('Circle')"><div class="icon">â­•</div><div class="label">Circle</div></div>
      <div class="add-obj-btn" onclick="addObject('Label')"><div class="icon">ğŸ”¤</div><div class="label">Label</div></div>
      <div class="add-obj-btn" onclick="addObject('Button')"><div class="icon">ğŸ”˜</div><div class="label">Button</div></div>
      <div class="add-obj-btn" onclick="addObject('Camera')"><div class="icon">ğŸ“·</div><div class="label">Camera</div></div>
      <div class="add-obj-btn" onclick="addObject('SpawnPoint')"><div class="icon">ğŸ“</div><div class="label">Spawn Point</div></div>
      <div class="add-obj-btn" onclick="addObject('Script')"><div class="icon">ğŸ“„</div><div class="label">Script Node</div></div>
    </div>
    <div class="modal-btns">
      <button class="mb-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let project       = null;
let objects       = [];       // scene objects
let selectedObj   = null;
let scriptTabs    = [];
let activeScriptTab = null;
let currentTool   = 'select';
let isPlaying     = false;
let zoom          = 1;
let panX = 0, panY = 0;
let snapToGrid    = false;
const GRID        = 25;

// drag state
let dragging = false;
let dragObj  = null;
let dragOffX = 0, dragOffY = 0;
let dragStart = null;

const canvas  = document.getElementById('viewport-canvas');
const ctx2d   = canvas.getContext('2d');
const wrap    = document.getElementById('viewport-canvas-wrap');
const editor  = document.getElementById('code-editor');
const lineNums = document.getElementById('line-nums');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWPORT RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resizeCanvas() {
  canvas.width  = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  drawScene();
}
new ResizeObserver(resizeCanvas).observe(wrap);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawScene() {
  const w = canvas.width, h = canvas.height;
  ctx2d.clearRect(0, 0, w, h);

  ctx2d.save();
  ctx2d.translate(panX + w/2, panY + h/2);
  ctx2d.scale(zoom, zoom);

  // Draw objects
  objects.forEach(obj => {
    ctx2d.save();
    ctx2d.translate(obj.x, obj.y);

    if (obj.type === 'Rectangle' || obj.type === 'Button' || obj.type === 'Sprite') {
      ctx2d.fillStyle = obj.color || '#FF6B00';
      ctx2d.fillRect(-obj.w/2, -obj.h/2, obj.w, obj.h);
      if (obj === selectedObj) {
        ctx2d.strokeStyle = '#FF6B00';
        ctx2d.lineWidth = 2 / zoom;
        ctx2d.strokeRect(-obj.w/2 - 1, -obj.h/2 - 1, obj.w + 2, obj.h + 2);
      }
    } else if (obj.type === 'Circle') {
      ctx2d.beginPath();
      ctx2d.arc(0, 0, obj.w/2, 0, Math.PI*2);
      ctx2d.fillStyle = obj.color || '#4da6ff';
      ctx2d.fill();
      if (obj === selectedObj) {
        ctx2d.strokeStyle = '#FF6B00'; ctx2d.lineWidth = 2/zoom; ctx2d.stroke();
      }
    } else if (obj.type === 'Label' || obj.type === 'Script') {
      ctx2d.fillStyle = obj.color || '#ffffff';
      ctx2d.font = `${obj.fontSize || 16}px Segoe UI`;
      ctx2d.textAlign = 'center';
      ctx2d.fillText(obj.text || obj.name, 0, 0);
      if (obj === selectedObj) {
        const tw = ctx2d.measureText(obj.text || obj.name).width;
        ctx2d.strokeStyle = '#FF6B00'; ctx2d.lineWidth = 1/zoom;
        ctx2d.strokeRect(-tw/2 - 4, -(obj.fontSize||16) - 4, tw + 8, (obj.fontSize||16) + 12);
      }
    } else if (obj.type === 'Camera') {
      ctx2d.strokeStyle = obj === selectedObj ? '#FF6B00' : '#4da6ff';
      ctx2d.lineWidth = 2/zoom;
      ctx2d.strokeRect(-obj.w/2, -obj.h/2, obj.w, obj.h);
      ctx2d.fillStyle = 'rgba(77,166,255,0.1)';
      ctx2d.fillRect(-obj.w/2, -obj.h/2, obj.w, obj.h);
      ctx2d.fillStyle = '#4da6ff'; ctx2d.font = `${12/zoom}px Segoe UI`; ctx2d.textAlign = 'center';
      ctx2d.fillText('ğŸ“· Camera', 0, 0);
    } else if (obj.type === 'SpawnPoint') {
      ctx2d.fillStyle = obj === selectedObj ? '#FF6B00' : '#6dc86d';
      ctx2d.beginPath();
      ctx2d.arc(0, 0, 8, 0, Math.PI*2);
      ctx2d.fill();
      ctx2d.fillStyle = '#fff'; ctx2d.font = `bold ${10/zoom}px Segoe UI`; ctx2d.textAlign = 'center';
      ctx2d.fillText('S', 0, 3);
    }

    // Name label
    if (obj !== selectedObj) {
      ctx2d.fillStyle = 'rgba(0,0,0,0.5)';
      ctx2d.font = `${10/zoom}px Segoe UI`;
      ctx2d.textAlign = 'center';
      const lw = ctx2d.measureText(obj.name).width;
      ctx2d.fillRect(-lw/2 - 2, -obj.h/2 - 16/zoom, lw + 4, 14/zoom);
      ctx2d.fillStyle = '#aaa';
      ctx2d.fillText(obj.name, 0, -obj.h/2 - 5/zoom);
    }

    ctx2d.restore();
  });

  // Selection info
  if (selectedObj) {
    ctx2d.save();
    ctx2d.translate(selectedObj.x, selectedObj.y);
    ctx2d.strokeStyle = '#FF6B00';
    ctx2d.lineWidth = 2/zoom;
    ctx2d.setLineDash([4/zoom, 3/zoom]);
    if (selectedObj.type === 'Circle') {
      ctx2d.beginPath(); ctx2d.arc(0,0,selectedObj.w/2+4,0,Math.PI*2); ctx2d.stroke();
    } else {
      ctx2d.strokeRect(-selectedObj.w/2-3, -selectedObj.h/2-3, selectedObj.w+6, selectedObj.h+6);
    }
    ctx2d.setLineDash([]);
    ctx2d.restore();
  }

  ctx2d.restore();
  document.getElementById('obj-count').textContent = objects.length + ' object' + (objects.length !== 1 ? 's' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWPORT MOUSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function worldPos(e) {
  const rect = wrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  return {
    x: (mx - wrap.clientWidth/2  - panX) / zoom,
    y: (my - wrap.clientHeight/2 - panY) / zoom
  };
}

function snap(v) { return snapToGrid ? Math.round(v / GRID) * GRID : v; }

function hitTest(wx, wy, obj) {
  if (obj.type === 'Circle') {
    const dx = wx - obj.x, dy = wy - obj.y;
    return Math.sqrt(dx*dx+dy*dy) <= obj.w/2;
  }
  return wx >= obj.x - obj.w/2 && wx <= obj.x + obj.w/2 &&
         wy >= obj.y - obj.h/2 && wy <= obj.y + obj.h/2;
}

function vpMouseDown(e) {
  if (e.button !== 0) return;
  const pos = worldPos(e);
  snapToGrid = e.shiftKey;
  document.getElementById('snap-status').textContent = snapToGrid ? 'ON' : 'OFF';

  // Hit test objects (reverse so top objects are selected first)
  let hit = null;
  for (let i = objects.length - 1; i >= 0; i--) {
    if (hitTest(pos.x, pos.y, objects[i])) { hit = objects[i]; break; }
  }

  if (hit) {
    selectedObj = hit;
    dragging = true;
    dragObj = hit;
    dragOffX = pos.x - hit.x;
    dragOffY = pos.y - hit.y;
    renderProperties();
    drawScene();
  } else {
    selectedObj = null;
    renderProperties();
    drawScene();
    // start pan
    if (currentTool === 'pan') {
      dragging = true;
      dragStart = { x: e.clientX - panX, y: e.clientY - panY };
    }
  }
}

function vpMouseMove(e) {
  if (!dragging) return;
  const pos = worldPos(e);
  snapToGrid = e.shiftKey;
  document.getElementById('snap-status').textContent = snapToGrid ? 'ON' : 'OFF';

  if (dragObj) {
    dragObj.x = snap(pos.x - dragOffX);
    dragObj.y = snap(pos.y - dragOffY);
    renderProperties();
    drawScene();
  } else if (dragStart) {
    panX = e.clientX - dragStart.x;
    panY = e.clientY - dragStart.y;
    drawScene();
  }
}

function vpMouseUp(e) {
  dragging = false; dragObj = null; dragStart = null;
}

function vpDblClick(e) {
  const pos = worldPos(e);
  for (let i = objects.length - 1; i >= 0; i--) {
    if (hitTest(pos.x, pos.y, objects[i])) {
      // Open attached script if any
      if (objects[i].script) openScriptTab({ path: objects[i].script, name: objects[i].name + '.pros', content: objects[i].scriptContent || '' });
      return;
    }
  }
  // Double click empty space = add object
  showAddObject();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OBJECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let objCounter = 1;
const objDefaults = {
  Rectangle:  { w:100, h:60,  color:'#FF6B00' },
  Sprite:     { w:80,  h:80,  color:'#dda0dd' },
  Circle:     { w:60,  h:60,  color:'#4da6ff' },
  Label:      { w:100, h:30,  color:'#ffffff', text:'Label', fontSize:16 },
  Button:     { w:120, h:40,  color:'#FF6B00', text:'Button' },
  Camera:     { w:200, h:150, color:'#4da6ff' },
  SpawnPoint: { w:20,  h:20,  color:'#6dc86d' },
  Script:     { w:60,  h:60,  color:'#ffc800', text:'Script' },
};

function addObject(type) {
  const def = objDefaults[type] || { w:80, h:80, color:'#fff' };
  const obj = {
    id:    Date.now(),
    name:  type + objCounter++,
    type,
    x: 0, y: 0,
    ...def
  };
  objects.push(obj);
  selectedObj = obj;
  closeModal();
  renderProperties();
  drawScene();
  markUnsaved();
}

function deleteSelected() {
  if (!selectedObj) return;
  objects = objects.filter(o => o !== selectedObj);
  selectedObj = null;
  renderProperties();
  drawScene();
  hideCtxMenu();
  markUnsaved();
}

function ctxDuplicate() {
  if (!selectedObj) return;
  const copy = { ...selectedObj, id: Date.now(), name: selectedObj.name + '_copy', x: selectedObj.x + 20, y: selectedObj.y + 20 };
  objects.push(copy);
  selectedObj = copy;
  renderProperties();
  drawScene();
  hideCtxMenu();
}

function ctxBringForward() {
  if (!selectedObj) return;
  const i = objects.indexOf(selectedObj);
  if (i < objects.length - 1) { [objects[i], objects[i+1]] = [objects[i+1], objects[i]]; drawScene(); }
  hideCtxMenu();
}

function ctxSendBack() {
  if (!selectedObj) return;
  const i = objects.indexOf(selectedObj);
  if (i > 0) { [objects[i], objects[i-1]] = [objects[i-1], objects[i]]; drawScene(); }
  hideCtxMenu();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPERTIES PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProperties() {
  const pc = document.getElementById('prop-content');
  if (!selectedObj) { pc.innerHTML = '<div class="prop-empty">Select an object<br>to edit its properties</div>'; return; }
  const o = selectedObj;
  pc.innerHTML = `
    <div class="obj-type-badge">${o.type}</div>
    <div class="prop-section">
      <div class="prop-section-title">Identity</div>
      <div class="prop-row"><span class="prop-label">Name</span><input class="prop-input" value="${o.name}" onchange="setProp('name',this.value)"/></div>
    </div>
    <div class="prop-section">
      <div class="prop-section-title">Transform</div>
      <div class="prop-row"><span class="prop-label">X</span><input class="prop-input" type="number" value="${Math.round(o.x)}" onchange="setProp('x',+this.value)"/></div>
      <div class="prop-row"><span class="prop-label">Y</span><input class="prop-input" type="number" value="${Math.round(o.y)}" onchange="setProp('y',+this.value)"/></div>
      <div class="prop-row"><span class="prop-label">Width</span><input class="prop-input" type="number" value="${o.w}" onchange="setProp('w',+this.value)"/></div>
      <div class="prop-row"><span class="prop-label">Height</span><input class="prop-input" type="number" value="${o.h}" onchange="setProp('h',+this.value)"/></div>
    </div>
    <div class="prop-section">
      <div class="prop-section-title">Appearance</div>
      <div class="prop-row"><span class="prop-label">Color</span><input class="prop-color" type="color" value="${o.color||'#FF6B00'}" onchange="setProp('color',this.value)"/><span style="font-size:11px;color:var(--text-dim);margin-left:4px;">${o.color||'#FF6B00'}</span></div>
      ${o.text !== undefined ? `<div class="prop-row"><span class="prop-label">Text</span><input class="prop-input" value="${o.text||''}" onchange="setProp('text',this.value)"/></div>` : ''}
      ${o.fontSize !== undefined ? `<div class="prop-row"><span class="prop-label">Font Size</span><input class="prop-input" type="number" value="${o.fontSize||16}" onchange="setProp('fontSize',+this.value)"/></div>` : ''}
    </div>
    <div class="prop-section">
      <div class="prop-section-title">Actions</div>
      <div class="prop-row" style="gap:6px;">
        <button onclick="deleteSelected()" style="flex:1;background:#3a1a1a;border:1px solid var(--red);color:var(--red);padding:5px;border-radius:5px;cursor:pointer;font-size:11px;">ğŸ—‘ Delete</button>
        <button onclick="ctxDuplicate()" style="flex:1;background:var(--bg-card);border:1px solid var(--border);color:var(--text-dim);padding:5px;border-radius:5px;cursor:pointer;font-size:11px;">â§‰ Duplicate</button>
      </div>
    </div>
  `;
}

function setProp(key, val) {
  if (!selectedObj) return;
  selectedObj[key] = val;
  drawScene();
  markUnsaved();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTool(t) {
  currentTool = t;
  document.querySelectorAll('.vp-tool').forEach(b => b.classList.remove('active'));
  document.getElementById('tool-'+t)?.classList.add('active');
  document.getElementById('status-mode').textContent = t.charAt(0).toUpperCase() + t.slice(1);
  wrap.style.cursor = t === 'pan' ? 'grab' : t === 'move' ? 'move' : 'default';
}

// Zoom
function zoomIn()    { zoom = Math.min(zoom * 1.2, 5); updateZoomLabel(); drawScene(); }
function zoomOut()   { zoom = Math.max(zoom / 1.2, 0.2); updateZoomLabel(); drawScene(); }
function resetZoom() { zoom = 1; panX = 0; panY = 0; updateZoomLabel(); drawScene(); }
function updateZoomLabel() { document.getElementById('zoom-label').textContent = Math.round(zoom*100)+'%'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRIPT EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openScriptTab(file) {
  const existing = scriptTabs.find(t => t.path === file.path);
  if (existing) { switchScriptTab(existing.id); return; }
  const id = Date.now();
  scriptTabs.push({ id, ...file, unsaved: false });
  switchScriptTab(id);
}

function switchScriptTab(id) {
  if (activeScriptTab) activeScriptTab.content = editor.value;
  activeScriptTab = scriptTabs.find(t => t.id === id);
  if (!activeScriptTab) return;
  editor.value = activeScriptTab.content || '';
  updateLineNumbers();
  renderScriptTabs();
  updateScriptStatus();
}

function closeScriptTab(id, e) {
  e.stopPropagation();
  const idx = scriptTabs.findIndex(t => t.id === id);
  scriptTabs.splice(idx, 1);
  if (activeScriptTab?.id === id) {
    activeScriptTab = scriptTabs[Math.min(idx, scriptTabs.length-1)] || null;
    editor.value = activeScriptTab?.content || '';
    updateLineNumbers();
  }
  renderScriptTabs();
}

function renderScriptTabs() {
  const container = document.getElementById('script-tabs');
  container.innerHTML = scriptTabs.map(t => `
    <div class="stab ${t.id === activeScriptTab?.id ? 'active':''} ${t.unsaved ? 'unsaved':''}" onclick="switchScriptTab(${t.id})">
      <span class="sdot"></span>
      <span>${t.name}</span>
      <button class="stab-close" onclick="closeScriptTab(${t.id},event)">Ã—</button>
    </div>
  `).join('');
}

function onCodeInput() {
  if (activeScriptTab) { activeScriptTab.unsaved = true; renderScriptTabs(); }
  updateLineNumbers();
  updateScriptStatus();
  markUnsaved();
}

function onCodeKey(e) {
  if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, '    '); }
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCurrentScript(); }
}

function syncLineNums() { lineNums.scrollTop = editor.scrollTop; }

function updateLineNumbers() {
  const count = (editor.value.match(/\n/g) || []).length + 1;
  lineNums.innerHTML = Array.from({length:count},(_,i)=>i+1).join('\n');
}

function updateScriptStatus() {
  const text = editor.value;
  const before = text.substring(0, editor.selectionStart);
  const lines = before.split('\n');
  document.getElementById('status-pos').textContent = `Ln ${lines.length}, Col ${lines[lines.length-1].length+1}`;
  document.getElementById('status-file').textContent = activeScriptTab?.name || 'No file';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function newProject() {
  const result = await window.studio.newProject();
  if (!result) return;
  project = result;
  objects = [];
  document.getElementById('project-name').textContent = result.name;
  renderFileTree(result.files);
  // Auto open main.pros
  const mainFile = result.files.find(f => f.name === 'main.pros');
  if (mainFile) {
    const data = await window.studio.readFile(mainFile.path);
    openScriptTab(data);
  }
  drawScene();
}

async function openProject() {
  const result = await window.studio.openFolder();
  if (!result) return;
  project = result;
  document.getElementById('project-name').textContent = result.name;
  renderFileTree(result.files);
  drawScene();
}

async function newScript() {
  const result = await window.studio.newScript(project?.path);
  if (!result) return;
  openScriptTab(result);
  if (project) renderFileTree(await window.studio.getFolderFiles?.(project.path) || []);
}

async function saveCurrentScript() {
  if (!activeScriptTab) return;
  activeScriptTab.content = editor.value;
  const saved = await window.studio.saveFile({ filePath: activeScriptTab.path, content: activeScriptTab.content });
  if (saved) { activeScriptTab.unsaved = false; renderScriptTabs(); }
}

async function saveScene() {
  const scene = { objects, version: '0.1.0' };
  await window.studio.saveScene({ filePath: null, scene });
}

async function openFileFromTree(path) {
  const data = await window.studio.readFile(path);
  if (data) openScriptTab(data);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE TREE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFileTree(files, container = document.getElementById('file-tree'), depth = 0) {
  if (depth === 0) {
    container.innerHTML = '';
    if (!files?.length) {
      container.innerHTML = '<div style="padding:12px;font-size:11px;color:var(--text-mute);">No .pros files found</div>';
      return;
    }
  }
  files.forEach(item => {
    const el = document.createElement('div');
    const indent = 12 + depth * 12;
    if (item.type === 'folder') {
      el.className = 'tree-item folder';
      el.style.paddingLeft = indent + 'px';
      el.innerHTML = `<span class="tree-icon">ğŸ“</span><span>${item.name}</span>`;
      const ch = document.createElement('div');
      ch.className = 'tree-children';
      ch.style.display = 'none';
      el.onclick = () => ch.style.display = ch.style.display === 'none' ? 'block' : 'none';
      container.appendChild(el);
      renderFileTree(item.children, ch, depth + 1);
      container.appendChild(ch);
    } else {
      el.className = 'tree-item';
      el.style.paddingLeft = indent + 'px';
      const icon = item.ext === '.pscene' ? 'ğŸ¬' : 'ğŸ“„';
      el.innerHTML = `<span class="tree-icon">${icon}</span><span>${item.name}</span>`;
      el.onclick = () => openFileFromTree(item.path);
      container.appendChild(el);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAY / STOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playGame() {
  isPlaying = true;
  document.getElementById('play-btn').style.display = 'none';
  document.getElementById('stop-btn').style.display = '';
  document.getElementById('play-status').textContent = 'â–¶ Playing';
  document.getElementById('play-status').style.color = '#6dc86d';
}

function stopGame() {
  isPlaying = false;
  document.getElementById('play-btn').style.display = '';
  document.getElementById('stop-btn').style.display = 'none';
  document.getElementById('play-status').textContent = 'â¹ Stopped';
  document.getElementById('play-status').style.color = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCtxMenu(e) {
  e.preventDefault();
  const m = document.getElementById('ctx-menu');
  m.style.display = 'block';
  m.style.left = e.clientX + 'px';
  m.style.top  = e.clientY + 'px';
}
function hideCtxMenu() { document.getElementById('ctx-menu').style.display = 'none'; }
document.addEventListener('click', hideCtxMenu);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAddObject() { document.getElementById('modal-overlay').classList.add('open'); }
function closeModal(e)   { if (!e || e.target === document.getElementById('modal-overlay')) document.getElementById('modal-overlay').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function markUnsaved() { document.getElementById('unsaved-dot').classList.add('on'); }
function openDocs()    { window.open?.('https://protonlanguage.github.io/docs'); }

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'v' || e.key === 'V') setTool('select');
  if (e.key === 'g' || e.key === 'G') setTool('move');
  if (e.key === 'h' || e.key === 'H') setTool('pan');
  if (e.key === 'Delete' && selectedObj && document.activeElement !== editor) deleteSelected();
  if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCurrentScript(); }
  if (e.ctrlKey && e.key === 'z') { document.execCommand('undo'); }
});

// Init
resizeCanvas();
updateLineNumbers();
</script>
</body>
</html>
